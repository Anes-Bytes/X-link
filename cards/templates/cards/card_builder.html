{% extends '_base.html' %}
{% load static %}
{% load custom_filters %}

{% block page_title %}کارت دیجیتالی - X-Link{% endblock %}

{% block page_content %}

<div class="card-builder-container">
    <div class="container">
        <div class="builder-header">
            <h1>ایجاد کارت دیجیتالی</h1>
            <p>اطلاعات خود را وارد کنید و کارت دیجیتالی خود را سفارش دهید</p>
        </div>

        <!-- Stepper Navigation -->
        <div class="stepper-wrapper">
            <div class="stepper-item active" data-step="1">
                <div class="step-counter">1</div>
                <div class="step-name">انتخاب قالب</div>
            </div>
            <div class="stepper-item" data-step="2">
                <div class="step-counter">2</div>
                <div class="step-name">رنگ و استایل</div>
            </div>
            <div class="stepper-item" data-step="3">
                <div class="step-counter">3</div>
                <div class="step-name">اطلاعات اصلی</div>
            </div>
            <div class="stepper-item" data-step="4">
                <div class="step-counter">4</div>
                <div class="step-name">شبکه‌های اجتماعی</div>
            </div>
            <div class="stepper-item" data-step="5">
                <div class="step-counter">5</div>
                <div class="step-name">مهارت‌ها و خدمات</div>
            </div>
        </div>

        <form method="post" class="card-form" id="cardForm" enctype="multipart/form-data" novalidate>
            {% csrf_token %}
<div id="empty-skill-form" style="display:none;">
    <div class="skill-form-group" data-form-index="__prefix__">
        <input type="hidden" name="skill-__prefix__-id" id="id_skill-__prefix__-id">
        <input type="hidden" name="skill-__prefix__-user_card" id="id_skill-__prefix__-user_card">

        <div class="skill-input-wrapper">
            <input type="text" name="skill-__prefix__-name" class="skill-input" placeholder="نام مهارت" maxlength="255" id="id_skill-__prefix__-name">

            <div class="skill-checkbox">
                <input type="checkbox" name="skill-__prefix__-DELETE" id="id_skill-__prefix__-DELETE">
                <label for="id_skill-__prefix__-DELETE">حذف</label>
            </div>
        </div>
    </div>
</div>
<div id="empty-service-form" style="display:none;">
    <div class="service-form-group" data-form-index="__prefix__">
        <input type="hidden" name="service-__prefix__-id" id="id_service-__prefix__-id">
        <input type="hidden" name="service-__prefix__-user_card" id="id_service-__prefix__-user_card">

        <div class="service-input-wrapper">
            <input type="text" name="service-__prefix__-title" class="service-input" placeholder="عنوان خدمت" maxlength="255" id="id_service-__prefix__-title">
            <textarea name="service-__prefix__-description" class="service-input" placeholder="توضیح خدمت" rows="3" maxlength="500" id="id_service-__prefix__-description"></textarea>

            <div class="service-checkbox">
                <input type="checkbox" name="service-__prefix__-DELETE" id="id_service-__prefix__-DELETE">
                <label for="id_service-__prefix__-DELETE">حذف</label>
            </div>
        </div>
    </div>
</div>
<div id="empty-portfolio-form" style="display:none;">
    <div class="portfolio-form-group" data-form-index="__prefix__">
        <input type="hidden" name="portfolio-__prefix__-id" id="id_portfolio-__prefix__-id">
        <input type="hidden" name="portfolio-__prefix__-user_card" id="id_portfolio-__prefix__-user_card">

        <div class="portfolio-input-wrapper">
            <input type="text" name="portfolio-__prefix__-title" class="portfolio-input" placeholder="عنوان پروژه" maxlength="255" id="id_portfolio-__prefix__-title">
            <input type="hidden" name="portfolio-__prefix__-image_data" id="id_portfolio-__prefix__-image_data">
            <div class="portfolio-image-upload">
                <input type="file" name="portfolio-__prefix__-image" class="portfolio-input" accept="image/*" id="id_portfolio-__prefix__-image">
                <div class="portfolio-preview-container" id="preview_portfolio-__prefix__" style="display:none;">
                    <img src="" alt="Preview" class="portfolio-preview-img">
                </div>
            </div>
            <input type="url" name="portfolio-__prefix__-url" class="portfolio-input" placeholder="https://example.com" id="id_portfolio-__prefix__-url">
            <textarea name="portfolio-__prefix__-description" class="portfolio-input" placeholder="توضیح پروژه" rows="3" maxlength="500" id="id_portfolio-__prefix__-description"></textarea>

            <div class="portfolio-checkbox">
                <input type="checkbox" name="portfolio-__prefix__-DELETE" id="id_portfolio-__prefix__-DELETE">
                <label for="id_portfolio-__prefix__-DELETE">حذف</label>
            </div>
        </div>
    </div>
</div>

            <!-- Step 1: Template Selection -->
            <div class="step-content active" id="step1">
                <div class="form-section">
                    <h2>مرحله 1: انتخاب قالب</h2>
                    
                    {% if templates %}
                    <div class="template-grid">
                        {% for template in templates %}
                            <div class="template-option {% if not template.is_allowed %}locked{% endif %} {% if form.instance.template.id == template.id %}selected{% endif %}"
                                 data-template-id="{{ template.id }}">
                                <div class="template-option-image">
                                    <img src="{{ template.image.url }}" alt="{{ template.name }}">
                                    {% if not template.is_allowed %}
                                        <div class="template-lock-overlay">
                                            <i class="fas fa-lock lock-icon"></i>
                                            <span class="plan-badge">
                                                {% for plan in template.allowed_plans.all %}
                                                    {{ plan.get_value_display }}{% if not forloop.last %} و {% endif %}
                                                {% endfor %}
                                            </span>
                                        </div>
                                    {% endif %}
                                </div>
                                <h4>{{ template.name }}</h4>
                                <div class="template-radio-wrapper">
                                    <input type="radio" name="template" value="{{ template.id }}"
                                           style="display: none;"
                                           {% if form.instance.template.id == template.id %}checked{% endif %}
                                           {% if not template.is_allowed %}disabled{% endif %}>
                                    <button type="button" class="template-select-btn">
                                        {% if template.is_allowed %}
                                            <i class="fas fa-check-circle"></i> انتخاب قالب
                                        {% else %}
                                            <i class="fas fa-lock"></i> غیرقابل انتخاب
                                        {% endif %}
                                    </button>
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                    {% endif %}
                </div>
                <div class="step-actions">
                    <button type="button" class="btn-next" onclick="nextStep(2)">مرحله بعد <i class="fas fa-arrow-left"></i></button>
                </div>
            </div>

            <!-- Step 2: Color Theme Selection -->
            <div class="step-content" id="step2">
                <div class="form-section">
                    <h2>مرحله 2: انتخاب رنگ</h2>
                    <div class="form-group">
                        <label>رنگ قالب</label>
                        <div style="display: none;">{{ form.color }}</div>
                        <div class="color-grid">
                            {% for value, label in color_choices %}
                                {% if value == 'default' or can_use_custom_colors %}
                                    <div class="color-item {% if form.initial.color == value or form.instance.color == value %}selected{% endif %}" 
                                         data-value="{{ value }}">
                                        <div class="color-preview {{ value }}"></div>
                                        <span class="color-label">{{ label }}</span>
                                    </div>
                                {% else %}
                                    <div class="color-item locked" title="ارتقا به پلن پایه یا حرفه‌ای برای استفاده از این رنگ">
                                        <div class="color-preview {{ value }} blurred"></div>
                                        <span class="color-label">{{ label }} <i class="fas fa-lock"></i></span>
                                    </div>
                                {% endif %}
                            {% endfor %}
                        </div>
                        {% if form.color.errors %}
                        <div class="error-message">{{ form.color.errors }}</div>
                        {% endif %}
                    </div>
                    {% if has_pro_plan %}
                    <div class="pro-features-grid">
                        <div class="extra-color-option pro-option">
                            <input
                                type="checkbox"
                                id="stars_bg"
                                name="stars_bg"
                                {% if form.instance.stars_background %}checked{% endif %}
                            >
                            <label for="stars_bg">بک‌گراند ستاره‌ای <span class="badge-pro">PRO</span></label>
                        </div>

                        <div class="extra-color-option pro-option">
                            <input
                                type="checkbox"
                                id="black_bg"
                                name="black_bg"
                                {% if form.instance.black_background %}checked{% endif %}
                            >
                            <label for="black_bg">رنگ مشکی <span class="badge-pro">PRO</span></label>
                        </div>

                        <div class="extra-color-option pro-option">
                            <input
                                type="checkbox"
                                id="blue_check"
                                name="blue_tick"
                                {% if form.instance.blue_tick %}checked{% endif %}
                            >
                            <label for="blue_check" style="cursor: pointer;">تیک آبی <span class="badge-pro">PRO</span></label>
                        </div>
                    </div>
                    {% else %}
                    <div class="pro-features-grid locked">
                        <div class="extra-color-option disabled">
                            <input type="checkbox" disabled>
                            <label>بک‌گراند ستاره‌ای <i class="fas fa-lock"></i></label>
                        </div>
                        <div class="extra-color-option disabled">
                            <input type="checkbox" disabled>
                            <label>رنگ مشکی <i class="fas fa-lock"></i></label>
                        </div>
                        <div class="extra-color-option disabled">
                            <input type="checkbox" disabled>
                            <label>تیک آبی <i class="fas fa-lock"></i></label>
                        </div>
                        <p class="pro-upgrade-hint">برای استفاده از این قابلیت‌ها <a href="{% url 'home' %}#pricing-landing">اشتراک خود را ارتقا دهید</a></p>
                    </div>
                    {% endif %}
                </div>
                <div class="step-actions">
                    <button type="button" class="btn-prev" onclick="prevStep(1)"><i class="fas fa-arrow-right"></i> مرحله قبل</button>
                    <button type="button" class="btn-next" onclick="nextStep(3)">مرحله بعد <i class="fas fa-arrow-left"></i></button>
                </div>
            </div>

            <!-- Step 3: Personal Information -->
            <div class="step-content" id="step3">
                <div class="form-section">
                    <h2>مرحله 3: اطلاعات شخصی</h2>

                    <div class="form-group">
                        <label for="{{ form.username.id_for_label }}">نام کاربری *</label>
                        {{ form.username }}
                        {% if form.username.errors %}
                        <div class="error-message">{{ form.username.errors }}</div>
                        {% endif %}
                        <small class="help-text">نام کاربری برای لینک کارت (مثال: example.com/username)</small>
                    </div>
                    <div class="form-group">
                        <label for="{{ form.phone_number.id_for_label }}">شماره تماس</label>
                        {{ form.phone_number }}
                        {% if form.phone_number.errors %}
                        <div class="error-message">{{ form.phone_number.errors }}</div>
                        {% endif %}
                        <small class="help-text">مثال: +98 912 345 6789</small>
                    </div>
                    <div class="form-group">
                        <label for="{{ form.profile_picture.id_for_label }}">آپلود عکس پروفایل *</label>
                        {{ form.profile_picture_data }}
                        <div class="profile-upload-wrapper">
                            <div class="profile-preview-container" id="profile_preview_container" style="{% if not form.instance.profile_picture %}display:none;{% endif %}">
                                <img src="{% if form.instance.profile_picture %}{{ form.instance.profile_picture.url }}{% endif %}" id="profile_preview_img" alt="پیش‌نمایش">
                            </div>
                            <div class="file-input-custom">
                                {{ form.profile_picture }}
                                <span><i class="fas fa-upload"></i> انتخاب فایل</span>
                            </div>
                        </div>
                        {% if form.profile_picture.errors %}
                        <div class="error-message">{{ form.profile_picture.errors }}</div>
                        {% endif %}
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="{{ form.name.id_for_label }}">نام کامل *</label>
                            {{ form.name }}
                            {% if form.name.errors %}
                            <div class="error-message">{{ form.name.errors }}</div>
                            {% endif %}
                        </div>

                        <div class="form-group">
                            <label for="{{ form.email.id_for_label }}">ایمیل</label>
                            {{ form.email }}
                            {% if form.email.errors %}
                            <div class="error-message">{{ form.email.errors }}</div>
                            {% endif %}
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="{{ form.short_bio.id_for_label }}">توضیح مختصر</label>
                            {{ form.short_bio }}
                            {% if form.short_bio.errors %}
                            <div class="error-message">{{ form.short_bio.errors }}</div>
                            {% endif %}
                        </div>

                        <div class="form-group">
                            <label for="{{ form.website.id_for_label }}">وبسایت</label>
                            {{ form.website }}
                            {% if form.website.errors %}
                            <div class="error-message">{{ form.website.errors }}</div>
                            {% endif %}
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="{{ form.description.id_for_label }}">توضیحات تفصیلی</label>
                        {{ form.description }}
                        {% if form.description.errors %}
                        <div class="error-message">{{ form.description.errors }}</div>
                        {% endif %}
                    </div>
                </div>
                <div class="step-actions">
                    <button type="button" class="btn-prev" onclick="prevStep(2)"><i class="fas fa-arrow-right"></i> مرحله قبل</button>
                    <button type="button" class="btn-next" onclick="nextStep(4)">مرحله بعد <i class="fas fa-arrow-left"></i></button>
                </div>
            </div>

            <!-- Step 4: Social Media -->
            <div class="step-content" id="step4">
                <div class="form-section">
                    <h2>مرحله 4: شبکه های اجتماعی</h2>

                    <div class="social-inputs">
                        <div class="form-group social-group">
                            <label for="{{ form.instagram_username.id_for_label }}">
                                <i class="fab fa-instagram"></i> Instagram
                            </label>
                            {{ form.instagram_username }}
                            {% if form.instagram_username.errors %}
                            <div class="error-message">{{ form.instagram_username.errors }}</div>
                            {% endif %}
                        </div>

                        <div class="form-group social-group">
                            <label for="{{ form.telegram_username.id_for_label }}">
                                <i class="fab fa-telegram-plane"></i> Telegram
                            </label>
                            {{ form.telegram_username }}
                            {% if form.telegram_username.errors %}
                            <div class="error-message">{{ form.telegram_username.errors }}</div>
                            {% endif %}
                        </div>

                        <div class="form-group social-group">
                            <label for="{{ form.linkedin_username.id_for_label }}">
                                <i class="fab fa-linkedin-in"></i> LinkedIn
                            </label>
                            {{ form.linkedin_username }}
                            {% if form.linkedin_username.errors %}
                            <div class="error-message">{{ form.linkedin_username.errors }}</div>
                            {% endif %}
                        </div>

                        <div class="form-group social-group">
                            <label for="{{ form.youtube_username.id_for_label }}">
                                <i class="fab fa-youtube"></i> YouTube
                            </label>
                            {{ form.youtube_username }}
                            {% if form.youtube_username.errors %}
                            <div class="error-message">{{ form.youtube_username.errors }}</div>
                            {% endif %}
                        </div>

                        <div class="form-group social-group">
                            <label for="{{ form.twitter_username.id_for_label }}">
                                <i class="fab fa-x-twitter"></i> X/Twitter
                            </label>
                            {{ form.twitter_username }}
                            {% if form.twitter_username.errors %}
                            <div class="error-message">{{ form.twitter_username.errors }}</div>
                            {% endif %}
                        </div>
                    </div>
                </div>
                <div class="step-actions">
                    <button type="button" class="btn-prev" onclick="prevStep(3)"><i class="fas fa-arrow-right"></i> مرحله قبل</button>
                    <button type="button" class="btn-next" onclick="nextStep(5)">مرحله بعد <i class="fas fa-arrow-left"></i></button>
                </div>
            </div>

            <!-- Skills Section -->
            <!-- Step 5: Skills, Services, and Portfolio -->
            <div class="step-content" id="step5">
                <!-- Skills Section -->
                <div class="form-section">
                    <h2>مرحله 5: مهارت‌ها</h2>
                    <div id="skillsContainer" class="skills-container">
                        {% for skill_form in skill_formset %}
                        <div class="skill-form-group" data-form-index="{{ forloop.counter0 }}">
                            {{ skill_form.id }}
                            <div class="skill-input-wrapper">
                                {{ skill_form.name }}
                                {% if skill_form.DELETE %}
                                <div class="skill-checkbox">
                                    {{ skill_form.DELETE }}
                                    <label for="{{ skill_form.DELETE.id_for_label }}">حذف</label>
                                </div>
                                {% endif %}
                            </div>
                            {% if skill_form.errors %}
                            <div class="error-message">{{ skill_form.errors }}</div>
                            {% endif %}
                        </div>
                        {% endfor %}
                    </div>
                    <button type="button" class="add-skill-btn" id="addSkillBtn">
                        <i class="fas fa-plus"></i> افزودن مهارت
                    </button>
                    <div style="display: none;">{{ skill_formset.management_form }}</div>
                </div>

                <!-- Services Section -->
                <div class="form-section">
                    <h2>خدمات</h2>
                    <div id="servicesContainer" class="services-container">
                        {% for service_form in service_formset %}
                        <div class="service-form-group" data-form-index="{{ forloop.counter0 }}">
                            {{ service_form.id }}
                            <div class="service-input-wrapper">
                                {{ service_form.title }}
                                {{ service_form.description }}
                                {% if service_form.DELETE %}
                                <div class="service-checkbox">
                                    {{ service_form.DELETE }}
                                    <label for="{{ service_form.DELETE.id_for_label }}">حذف</label>
                                </div>
                                {% endif %}
                            </div>
                            {% if service_form.errors %}
                            <div class="error-message">{{ service_form.errors }}</div>
                            {% endif %}
                        </div>
                        {% endfor %}
                    </div>
                    <button type="button" class="add-service-btn" id="addServiceBtn">
                        <i class="fas fa-plus"></i> افزودن خدمت
                    </button>
                    <div style="display: none;">{{ service_formset.management_form }}</div>
                </div>

                <!-- Portfolio Section -->
                <div class="form-section">
                    <h2>نمونه کارها</h2>
                    <div id="portfolioContainer" class="portfolio-container">
                        {% for portfolio_form in portfolio_formset %}
                        <div class="portfolio-form-group" data-form-index="{{ forloop.counter0 }}">
                            {{ portfolio_form.id }}
                            <div class="portfolio-input-wrapper">
                                {{ portfolio_form.title }}
                                {{ portfolio_form.image_data }}
                                <div class="portfolio-image-upload">
                                    <div class="portfolio-preview-container" id="preview_{{ portfolio_form.prefix }}" style="{% if not portfolio_form.instance.image %}display:none;{% endif %}">
                                        <img src="{% if portfolio_form.instance.image %}{{ portfolio_form.instance.image.url }}{% endif %}" class="portfolio-preview-img" alt="پیش‌نمایش">
                                    </div>
                                    {{ portfolio_form.image }}
                                </div>
                                {{ portfolio_form.url }}
                                {{ portfolio_form.description }}
                                {% if portfolio_form.DELETE %}
                                <div class="portfolio-checkbox">
                                    {{ portfolio_form.DELETE }}
                                    <label for="{{ portfolio_form.DELETE.id_for_label }}">حذف</label>
                                </div>
                                {% endif %}
                            </div>
                            {% if portfolio_form.errors %}
                            <div class="error-message">{{ portfolio_form.errors }}</div>
                            {% endif %}
                        </div>
                        {% endfor %}
                    </div>
                    <button type="button" class="add-portfolio-btn" id="addPortfolioBtn">
                        <i class="fas fa-plus"></i> افزودن نمونه کار
                    </button>
                    <div style="display: none;">{{ portfolio_formset.management_form }}</div>
                </div>

                <div class="step-actions">
                    <button type="button" class="btn-prev" onclick="prevStep(4)"><i class="fas fa-arrow-right"></i> مرحله قبل</button>
                    <button type="submit" class="btn-submit">ثبت و ایجاد کارت <i class="fas fa-check"></i></button>
                </div>
            </div>
<script>
    let currentStep = 1;

    function showStep(step) {
        window.scrollTo({ top: 0, behavior: 'smooth' });
        const currentActive = document.querySelector('.step-content.active');
        const nextTarget = document.getElementById(`step${step}`);
        
        if (currentActive && currentActive !== nextTarget) {
            // Exit animation
            currentActive.classList.add('exit');
            currentActive.classList.remove('active');
            
            setTimeout(() => {
                currentActive.style.display = 'none';
                currentActive.classList.remove('exit');
                activateNextStep(nextTarget, step);
            }, 500); // Matches CSS transition duration
        } else {
            activateNextStep(nextTarget, step);
        }
    }

    function activateNextStep(nextTarget, step) {
        // Update Stepper UI
        document.querySelectorAll('.stepper-item').forEach(item => {
            const itemStep = parseInt(item.dataset.step);
            item.classList.remove('active', 'completed');
            if (itemStep === step) {
                item.classList.add('active');
            } else if (itemStep < step) {
                item.classList.add('completed');
            }
        });

        // Entrance animation
        nextTarget.style.display = 'block';
        // Reset transform before adding active
        nextTarget.style.transform = 'translateX(30px)';
        nextTarget.style.opacity = '0';
        
        // Force reflow
        nextTarget.offsetHeight;
        
        setTimeout(() => {
            nextTarget.classList.add('active');
            nextTarget.style.transform = ''; // Clear inline styles to use CSS
            nextTarget.style.opacity = '';
            currentStep = step;
        }, 50);
    }

    function nextStep(step) {
        showStep(step);
    }

    function prevStep(step) {
        showStep(step);
    }

    document.addEventListener('DOMContentLoaded', () => {
        // Check for errors and jump to the relevant step
        const firstError = document.querySelector('.error-message');
        if (firstError) {
            const stepContent = firstError.closest('.step-content');
            if (stepContent) {
                const stepId = stepContent.id.replace('step', '');
                showStep(parseInt(stepId));
            }
        } else {
            // Initialize first step if no errors
            showStep(1);
        }

        // Template Selection Highlight
        document.querySelectorAll('.template-option').forEach(option => {
            const radio = option.querySelector('input[type="radio"]');
            
            if (radio && radio.checked) {
                option.classList.add('selected');
            }

            option.addEventListener('click', () => {
                if (option.classList.contains('locked')) return;
                
                document.querySelectorAll('.template-option').forEach(opt => opt.classList.remove('selected'));
                option.classList.add('selected');
                if (radio) radio.checked = true;
            });
        });

        // Color Selection Logic
        const colorSelect = document.querySelector('.color-select');
        document.querySelectorAll('.color-item:not(.locked)').forEach(item => {
            item.addEventListener('click', () => {
                document.querySelectorAll('.color-item').forEach(i => i.classList.remove('selected'));
                item.classList.add('selected');
                const val = item.dataset.value;
                if (colorSelect) {
                    colorSelect.value = val;
                }
            });
        });

        // Add Form Logic (Dynamic fields)
        function addForm(containerId, emptyFormId, totalFormsName) {
            const container = document.getElementById(containerId);
            const template = document.getElementById(emptyFormId);
            const totalFormsInput = document.querySelector(`[name="${totalFormsName}"]`);

            if (!container || !template || !totalFormsInput) return;

            const formIndex = parseInt(totalFormsInput.value, 10);
            const newFormHtml = template.innerHTML.replace(/__prefix__/g, formIndex);
            
            // Create a temporary div to handle animation
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = newFormHtml;
            const newForm = tempDiv.firstElementChild;
            newForm.style.opacity = '0';
            newForm.style.transform = 'translateY(10px)';
            
            container.appendChild(newForm);
            
            // Trigger animation
            setTimeout(() => {
                newForm.style.transition = 'all 0.3s ease';
                newForm.style.opacity = '1';
                newForm.style.transform = 'translateY(0)';
            }, 10);

            totalFormsInput.value = formIndex + 1;
        }

        const addSkillBtn = document.getElementById('addSkillBtn');
        const addServiceBtn = document.getElementById('addServiceBtn');
        const addPortfolioBtn = document.getElementById('addPortfolioBtn');

        if (addSkillBtn) addSkillBtn.addEventListener('click', () => addForm('skillsContainer', 'empty-skill-form', 'skill-TOTAL_FORMS'));
        if (addServiceBtn) addServiceBtn.addEventListener('click', () => addForm('servicesContainer', 'empty-service-form', 'service-TOTAL_FORMS'));
        
        if (addPortfolioBtn) {
            addPortfolioBtn.addEventListener('click', () => {
                addForm('portfolioContainer', 'empty-portfolio-form', 'portfolio-TOTAL_FORMS');
                // Setup preview for the newly added form
                const totalForms = document.querySelector('[name="portfolio-TOTAL_FORMS"]');
                const newIndex = parseInt(totalForms.value) - 1;
                const newFileInput = document.querySelector(`[name="portfolio-${newIndex}-image"]`);
                const newHiddenInput = document.querySelector(`[name="portfolio-${newIndex}-image_data"]`);
                const newPreviewContainer = document.getElementById(`preview_portfolio-${newIndex}`);
                const newPreviewImg = newPreviewContainer ? newPreviewContainer.querySelector('img') : null;
                
                if (newFileInput) {
                    setupImagePreview(newFileInput, newHiddenInput, newPreviewContainer, newPreviewImg);
                }
            });
        }

        // Image Persistence & Preview Logic
        function setupImagePreview(fileInput, hiddenInput, previewContainer, previewImg) {
            if (!fileInput) return;
            
            fileInput.addEventListener('change', function() {
                const file = this.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const base64Data = e.target.result;
                        if (hiddenInput) hiddenInput.value = base64Data;
                        if (previewImg) previewImg.src = base64Data;
                        if (previewContainer) previewContainer.style.display = 'block';
                    };
                    reader.readAsDataURL(file);
                }
            });
        }

        // Setup for Profile Picture
        const profileInput = document.getElementById('profile_picture_input');
        const profileHidden = document.querySelector('[name="profile_picture_data"]');
        const profilePreviewContainer = document.getElementById('profile_preview_container');
        const profilePreviewImg = document.getElementById('profile_preview_img');
        
        setupImagePreview(profileInput, profileHidden, profilePreviewContainer, profilePreviewImg);

        // Setup for existing Portfolio items
        document.querySelectorAll('.portfolio-form-group').forEach(group => {
            const idx = group.dataset.formIndex;
            if (idx === undefined) return;
            const fInput = group.querySelector(`[name="portfolio-${idx}-image"]`);
            const hInput = group.querySelector(`[name="portfolio-${idx}-image_data"]`);
            const pContainer = document.getElementById(`preview_portfolio-${idx}`);
            const pImg = pContainer ? pContainer.querySelector('img') : null;
            setupImagePreview(fInput, hInput, pContainer, pImg);
            
            // If we have persisted data (from a previous error), show it
            if (hInput && hInput.value && pImg && pContainer) {
                pImg.src = hInput.value;
                pContainer.style.display = 'block';
            }
        });

        // Persist profile picture if hidden data exists
        if (profileHidden && profileHidden.value && profilePreviewImg && profilePreviewContainer) {
            profilePreviewImg.src = profileHidden.value;
            profilePreviewContainer.style.display = 'block';
        }
    });
</script>



        </form>
    </div>
</div>

<!-- Card Builder Styles -->
<style>
/* Modern Card Builder Styles */
.card-builder-container {
    min-height: auto;
    padding: 70px 20px 40px;
    background: radial-gradient(circle at top right, rgba(58, 134, 255, 0.1), transparent),
                radial-gradient(circle at bottom left, rgba(0, 246, 255, 0.05), transparent),
                linear-gradient(135deg, #0A0F1F 0%, #16213E 100%);
    display: block;
}

.builder-header {
    text-align: center;
    margin-bottom: 20px;
}

.builder-header h1 {
    font-size: clamp(1.8rem, 4vw, 2.5rem);
    font-weight: 800;
    margin-bottom: 10px;
    background: linear-gradient(135deg, #fff 0%, var(--cyan-neon) 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
}

/* Stepper Styles */
.stepper-wrapper {
    display: flex;
    justify-content: space-between;
    max-width: 800px;
    margin: 0 auto 30px;
    position: relative;
    padding: 0 10px;
}

.stepper-wrapper::before {
    content: '';
    position: absolute;
    top: 20px;
    left: 40px;
    right: 40px;
    height: 2px;
    background: rgba(255, 255, 255, 0.1);
    z-index: 1;
}

.stepper-item {
    position: relative;
    z-index: 2;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 10px;
    flex: 1;
}

.step-counter {
    width: 42px;
    height: 42px;
    border-radius: 50%;
    background: #1a1a2e;
    border: 2px solid rgba(255, 255, 255, 0.1);
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--text-gray);
    font-weight: 700;
    transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
}

.step-name {
    font-size: 13px;
    color: var(--text-gray);
    font-weight: 500;
    text-align: center;
    transition: all 0.3s ease;
}

.stepper-item.active .step-counter {
    background: var(--cyan-neon);
    color: #0A0F1F;
    border-color: var(--cyan-neon);
    box-shadow: 0 0 20px rgba(0, 246, 255, 0.4);
    transform: scale(1.1);
}

.stepper-item.active .step-name {
    color: var(--cyan-neon);
    font-weight: 700;
}

.stepper-item.completed .step-counter {
    background: var(--primary-blue);
    border-color: var(--primary-blue);
    color: #fff;
}

/* Step Content Animation */
.step-content {
    display: none;
    max-width: 900px;
    margin: 0 auto;
    opacity: 0;
    transform: translateX(30px);
    transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
    will-change: transform, opacity;
}

.step-content.active {
    display: block !important;
    opacity: 1;
    transform: translateX(0);
}

.step-content.exit {
    opacity: 0;
    transform: translateX(-30px);
}

/* Glassmorphism Section */
.form-section {
    background: rgba(255, 255, 255, 0.03);
    backdrop-filter: blur(12px);
    -webkit-backdrop-filter: blur(12px);
    border: 1px solid rgba(255, 255, 255, 0.08);
    border-radius: 24px;
    padding: 30px;
    margin-bottom: 25px;
    box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
}

.form-section h2 {
    font-size: 1.3rem;
    font-weight: 700;
    color: #fff;
    margin-bottom: 20px;
    padding-bottom: 12px;
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
}

/* Form Controls */
.form-group {
    margin-bottom: 25px;
}

.form-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
}

.form-group label {
    display: block;
    margin-bottom: 10px;
    color: rgba(255, 255, 255, 0.9);
    font-weight: 600;
    font-size: 15px;
}

.form-group input, 
.form-group textarea, 
.form-group select,
.skill-input,
.service-input,
.portfolio-input {
    width: 100%;
    background: rgba(255, 255, 255, 0.05) !important;
    border: 1px solid rgba(255, 255, 255, 0.1) !important;
    border-radius: 12px !important;
    padding: 14px 18px !important;
    color: #fff !important;
    font-family: inherit;
    transition: all 0.3s ease;
    appearance: none; /* For better control */
}

/* Fix for dropdown options visibility */
select option {
    background-color: #16213E !important;
    color: #fff !important;
    padding: 10px;
}

.form-group select {
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='white' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: left 15px center;
    background-size: 18px;
    padding-left: 45px !important;
}

.form-group input:focus, 
.form-group textarea:focus,
.form-group select:focus,
.skill-input:focus,
.service-input:focus,
.portfolio-input:focus {
    background: rgba(255, 255, 255, 0.08) !important;
    border-color: var(--cyan-neon) !important;
    box-shadow: 0 0 15px rgba(0, 246, 255, 0.2), inset 0 0 5px rgba(0, 246, 255, 0.1);
    outline: none;
    transform: translateY(-2px);
}

/* Template Grid Improvements */
.color-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
    gap: 15px;
    margin-top: 15px;
}

.color-item {
    background: rgba(255, 255, 255, 0.03);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 12px;
    padding: 12px;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 8px;
    cursor: pointer;
    transition: all 0.3s ease;
}

.color-item:hover:not(.locked) {
    background: rgba(255, 255, 255, 0.08);
    transform: translateY(-3px);
    border-color: rgba(255, 255, 255, 0.2);
}

.color-item.selected {
    background: rgba(0, 246, 255, 0.1);
    border-color: var(--cyan-neon);
    box-shadow: 0 0 15px rgba(0, 246, 255, 0.2);
}

.color-preview {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    border: 2px solid rgba(255, 255, 255, 0.2);
}

.color-preview.default { background: #3a86ff; }
.color-preview.gold { background: #ffd700; }
.color-preview.orange { background: #ff7800; }
.color-preview.gray { background: #808080; }
.color-preview.mint { background: #3eb489; }
.color-preview.pink { background: #ff69b4; }
.color-preview.purple { background: #8a2be2; }
.color-preview.red { background: #ff0000; }
.color-preview.green { background: #00ff00; }

.color-preview.blurred {
    opacity: 0.6;
}

.color-item.locked {
    cursor: not-allowed;
    opacity: 0.8;
    background: rgba(255, 255, 255, 0.01);
}

.color-label {
    font-size: 12px;
    font-weight: 500;
    color: #fff;
    text-align: center;
}

.template-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
    gap: 30px;
}

.template-option {
    position: relative;
    background: rgba(255, 255, 255, 0.03);
    border: 2px solid rgba(255, 255, 255, 0.05);
    border-radius: 20px;
    padding: 12px;
    transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    display: flex;
    flex-direction: column;
    cursor: pointer;
}

.template-option:hover:not(.locked) {
    transform: translateY(-10px);
    background: rgba(255, 255, 255, 0.08);
    border-color: rgba(0, 246, 255, 0.3);
    box-shadow: 0 15px 35px rgba(0, 0, 0, 0.5), 0 0 20px rgba(0, 246, 255, 0.1);
}

.template-option.selected {
    border-color: var(--cyan-neon);
    background: rgba(0, 246, 255, 0.08);
    box-shadow: 0 0 30px rgba(0, 246, 255, 0.2);
}

.template-option.selected::before {
    content: '\f058';
    font-family: 'Font Awesome 6 Free';
    font-weight: 900;
    position: absolute;
    top: -10px;
    right: -10px;
    color: var(--cyan-neon);
    font-size: 24px;
    z-index: 10;
    background: #0A0F1F;
    border-radius: 50%;
    animation: scaleIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
}

@keyframes scaleIn {
    from { transform: scale(0); }
    to { transform: scale(1); }
}

.template-option-image {
    height: 380px;
    border-radius: 14px;
    overflow: hidden;
    margin-bottom: 15px;
    position: relative;
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
}

.template-option img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    transition: transform 0.5s ease;
}

.template-option:hover img {
    transform: scale(1.05);
}

.template-option h4 {
    margin: 0 0 15px 0;
    font-size: 16px;
    text-align: center;
    color: #fff;
    font-weight: 600;
}

.template-radio-wrapper {
    margin-top: auto;
}

.template-select-btn {
    width: 100%;
    padding: 10px;
    border-radius: 12px;
    border: 1px solid rgba(0, 246, 255, 0.3);
    background: rgba(0, 246, 255, 0.05);
    color: var(--cyan-neon);
    font-weight: 700;
    font-size: 14px;
    transition: all 0.3s ease;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
}

.template-option:hover .template-select-btn {
    background: var(--cyan-neon);
    color: #0A0F1F;
}

.template-option.selected .template-select-btn {
    background: var(--cyan-neon);
    color: #0A0F1F;
}

.template-option.locked {
    cursor: not-allowed;
}

.template-lock-overlay {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(10, 15, 31, 0.6);
    backdrop-filter: blur(2px);
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    z-index: 5;
    opacity: 0;
    transition: opacity 0.3s ease;
}

.template-option.locked:hover .template-lock-overlay {
    opacity: 1;
}

.lock-icon {
    font-size: 40px;
    color: #fff;
    margin-bottom: 15px;
    text-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
}

.plan-badge {
    background: linear-gradient(135deg, #FFD700, #FFA500);
    color: #000;
    padding: 4px 12px;
    border-radius: 20px;
    font-size: 11px;
    font-weight: 800;
}

.template-option.locked .template-select-btn {
    background: rgba(255, 255, 255, 0.05);
    border-color: rgba(255, 255, 255, 0.1);
    color: rgba(255, 255, 255, 0.3);
}

/* Pro Features */
.pro-features-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 15px;
    margin-top: 20px;
}

.pro-option {
    background: rgba(0, 246, 255, 0.05);
    border: 1px solid rgba(0, 246, 255, 0.2);
    padding: 15px;
    border-radius: 12px;
    display: flex;
    align-items: center;
    gap: 10px;
}

.badge-pro {
    background: linear-gradient(135deg, #00F6FF, #00D1FF);
    color: #000;
    font-size: 10px;
    font-weight: 900;
    padding: 2px 6px;
    border-radius: 4px;
    margin-right: 5px;
}

/* Dynamic Add Buttons */
.add-skill-btn, 
.add-service-btn, 
.add-portfolio-btn {
    background: rgba(0, 246, 255, 0.05);
    border: 1px dashed var(--cyan-neon);
    color: var(--cyan-neon);
    padding: 12px 24px;
    border-radius: 12px;
    cursor: pointer;
    font-weight: 700;
    font-size: 14px;
    transition: all 0.3s ease;
    display: inline-flex;
    align-items: center;
    gap: 10px;
    margin-top: 10px;
}

.add-skill-btn:hover, 
.add-service-btn:hover, 
.add-portfolio-btn:hover {
    background: var(--cyan-neon);
    color: #0A0F1F;
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(0, 246, 255, 0.2);
}

.error-message, .errorlist {
    color: #ff4d4d !important;
    background: rgba(255, 77, 77, 0.1);
    border: 1px solid rgba(255, 77, 77, 0.2);
    padding: 10px 15px;
    border-radius: 8px;
    font-size: 13px;
    margin-top: 8px;
    list-style: none;
    display: block;
    font-weight: 600;
}

.errorlist li {
    margin-bottom: 0;
}

/* Skills and Services spacing */
.skill-form-group, 
.service-form-group, 
.portfolio-form-group {
    background: rgba(255, 255, 255, 0.02);
    padding: 25px;
    border-radius: 20px;
    border: 1px solid rgba(255, 255, 255, 0.05);
    margin-bottom: 25px;
    animation: fadeIn 0.4s ease-out;
}

.skill-input-wrapper,
.service-input-wrapper,
.portfolio-input-wrapper {
    display: flex;
    flex-direction: column;
    gap: 15px;
}

.skill-input, 
.service-input, 
.portfolio-input {
    margin-bottom: 5px;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}

.profile-preview-container, .portfolio-preview-container {
    width: 100px;
    height: 100px;
    border-radius: 50%;
    overflow: hidden;
    border: 3px solid var(--cyan-neon);
    margin-bottom: 10px;
    background: rgba(0, 0, 0, 0.2);
}

.portfolio-preview-container {
    border-radius: 12px;
    width: 150px;
    height: 100px;
}

.profile-preview-container img, .portfolio-preview-container img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

/* Step Actions */
.step-actions {
    display: flex;
    justify-content: space-between;
    margin-top: 40px;
    gap: 20px;
}

.btn-next, .btn-submit, .btn-prev {
    padding: 16px 32px;
    border-radius: 14px;
    font-weight: 700;
    font-size: 16px;
    cursor: pointer;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    display: inline-flex;
    align-items: center;
    gap: 12px;
    border: none;
}

.btn-next, .btn-submit {
    background: linear-gradient(135deg, var(--primary-blue), var(--cyan-neon));
    color: #0A0F1F;
}

.btn-prev {
    background: rgba(255, 255, 255, 0.05);
    color: #fff;
    border: 1px solid rgba(255, 255, 255, 0.1);
}

.btn-next:hover, .btn-submit:hover {
    transform: translateY(-3px);
    box-shadow: 0 10px 25px rgba(0, 246, 255, 0.3);
}

/* Mobile Responsive */
@media (max-width: 768px) {
    .stepper-wrapper {
        padding: 0;
    }
    .step-name {
        display: none;
    }
    .form-section {
        padding: 25px;
    }
    .profile-upload-wrapper {
        flex-direction: column;
        align-items: center;
    }
    .form-row {
        grid-template-columns: 1fr;
    }
    .card-builder-container {
        padding-top: 80px;
    }
}
</style>

{% endblock %}