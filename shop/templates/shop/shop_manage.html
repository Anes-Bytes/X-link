{% extends "_base.html" %}

{% load static %}
{% block page_title %}مدیریت فروشگاه{% endblock %}

{% block styles %}
<style>
    .manage-shell {
        min-height: 100vh;
        padding: 90px 16px 40px;
        background: radial-gradient(circle at 0% 0%, rgba(58, 134, 255, 0.17), transparent 30%),
                    radial-gradient(circle at 100% 100%, rgba(0, 246, 255, 0.11), transparent 35%),
                    #090f1e;
    }
    .manage-wrap {
        max-width: 1080px;
        margin: 0 auto;
    }
    .glass {
        background: rgba(255, 255, 255, 0.03);
        border: 1px solid rgba(255, 255, 255, 0.12);
        border-radius: 18px;
        padding: 18px;
        margin-bottom: 14px;
    }
    .title {
        color: #fff;
        margin-top: 0;
    }
    .subtle { color: rgba(255,255,255,.7); margin-top: 0; }
    .limit-box {
        border: 1px solid rgba(0,246,255,.35);
        background: rgba(0,246,255,.08);
        color: #b7f5ff;
        padding: 10px 12px;
        border-radius: 12px;
        margin-bottom: 12px;
    }
    .form-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 12px;
    }
    .product-item {
        margin-bottom: 12px;
        border: 1px solid rgba(58, 134, 255, 0.2);
    }
    .inline-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 10px;
    }
    .inline-row3 {
        display: grid;
        grid-template-columns: 1fr 1fr 1fr;
        gap: 10px;
    }
    .preview-image {
        width: 100%;
        max-width: 180px;
        aspect-ratio: 4/3;
        object-fit: cover;
        border-radius: 10px;
        border: 1px solid rgba(255,255,255,.2);
        margin-top: 8px;
    }
    label {
        display: block;
        color: rgba(255, 255, 255, 0.9);
        margin-bottom: 6px;
        font-size: .9rem;
    }
    .form-control {
        width: 100%;
        background: rgba(255, 255, 255, 0.06);
        border: 1px solid rgba(255, 255, 255, 0.14);
        color: #fff;
        border-radius: 10px;
        padding: 10px 12px;
    }
    .subdomain-status {
        margin-top: 8px;
        font-size: 13px;
        font-weight: 600;
        min-height: 18px;
    }
    .subdomain-status.is-ok { color: #22c55e; }
    .subdomain-status.is-error { color: #ef4444; }
    .btn-main {
        border: 0;
        padding: 12px 16px;
        border-radius: 12px;
        font-weight: 700;
        background: linear-gradient(135deg, #3a86ff, #00f6ff);
        color: #081224;
        cursor: pointer;
    }
    .btn-ghost {
        border: 1px dashed rgba(0, 246, 255, 0.6);
        background: rgba(0, 246, 255, 0.08);
        color: #8aefff;
        padding: 10px 14px;
        border-radius: 10px;
        cursor: pointer;
    }
    .danger {
        color: #ff9a9a;
        font-size: .86rem;
    }
    @media (max-width: 768px) {
        .form-grid, .inline-row, .inline-row3 { grid-template-columns: 1fr; }
    }
</style>
{% endblock %}

{% block page_content %}
<section class="manage-shell">
    <div class="manage-wrap">
        <h1 class="title">مدیریت {{ shop.name }}</h1>
        <p class="subtle">محصولات را اضافه/ویرایش کنید و تخفیف‌ها را تنظیم کنید.</p>

        <div class="limit-box">
            تعداد محصول فعلی: <strong>{{ current_product_count }}</strong> از <strong>{{ product_limit }}</strong>
            <span style="opacity:.9;">(براساس پلن شما)</span>
        </div>

        <form method="post" enctype="multipart/form-data">
            {% csrf_token %}

            <div class="glass">
                <h3 class="title">تنظیمات سایت فروشگاهی</h3>
                <div class="form-grid">
                    <div>
                        <label for="{{ shop_form.name.id_for_label }}">نام سایت</label>
                        {{ shop_form.name }}
                    </div>
                    <div>
                        <label for="{{ shop_form.logo.id_for_label }}">لوگو</label>
                        {{ shop_form.logo }}
                    </div>
                </div>
                <div style="margin-top: 12px;">
                    <label for="shop_manage_subdomain">ساب‌دامین</label>
                    <input
                        id="shop_manage_subdomain"
                        name="subdomain"
                        type="text"
                        class="form-control js-subdomain-input"
                        data-status-target="shop-manage-subdomain-status"
                        value="{{ current_subdomain }}"
                        placeholder="example"
                        autocomplete="off"
                    >
                    <div id="shop-manage-subdomain-status" class="subdomain-status" data-check-url="{% url 'check_subdomain' %}"></div>
                </div>
                <div style="margin-top: 10px;">
                    <label>{{ shop_form.is_active }} فعال</label>
                </div>
            </div>

            <div class="glass">
                <h3 class="title">محصولات</h3>
                {{ formset.management_form }}
                <div id="products-container">
                    {% for form in formset %}
                    <div class="glass product-item">
                        {{ form.id }}
                        <div class="inline-row">
                            <div>
                                <label>نام محصول</label>
                                {{ form.name }}
                            </div>
                            <div>
                                <label>تصویر</label>
                                {{ form.image }}
                                {% if form.instance.image %}
                                <img src="{{ form.instance.image.url }}" alt="{{ form.instance.name|default:'تصویر محصول' }}" class="preview-image">
                                {% endif %}
                            </div>
                        </div>
                        <div style="margin-top:10px;">
                            <label>توضیح کوتاه</label>
                            {{ form.short_description }}
                        </div>
                        <div class="inline-row3" style="margin-top:10px;">
                            <div>
                                <label>قیمت</label>
                                {{ form.price }}
                            </div>
                            <div>
                                <label>تخفیف (%)</label>
                                {{ form.discount_percent }}
                            </div>
                            <div>
                                <label>لینک خرید</label>
                                {{ form.buy_link }}
                            </div>
                        </div>
                        <div style="margin-top:10px;">
                            <label>{{ form.is_active }} فعال</label>
                            {% if form.DELETE %}
                            <label class="danger">{{ form.DELETE }} حذف محصول</label>
                            {% endif %}
                        </div>
                        {% if form.errors %}
                        <div class="danger">{{ form.errors }}</div>
                        {% endif %}
                    </div>
                    {% endfor %}
                </div>

                <button type="button" id="add-product" class="btn-ghost">+ افزودن محصول جدید</button>
            </div>

            <div style="display:flex; gap:10px; flex-wrap:wrap;">
                <button type="submit" class="btn-main">ذخیره تغییرات</button>
                <a href="{% url 'shop_view' shop.id %}" target="_blank" class="btn-ghost">مشاهده فروشگاه</a>
                <a href="{% url 'dashboard' %}" class="btn-ghost">بازگشت به داشبورد</a>
            </div>
        </form>
    </div>

    <template id="empty-form-template">
        <div class="glass product-item">
            {{ formset.empty_form.id }}
            <div class="inline-row">
                <div>
                    <label>نام محصول</label>
                    {{ formset.empty_form.name }}
                </div>
                <div>
                    <label>تصویر</label>
                    {{ formset.empty_form.image }}
                </div>
            </div>
            <div style="margin-top:10px;">
                <label>توضیح کوتاه</label>
                {{ formset.empty_form.short_description }}
            </div>
            <div class="inline-row3" style="margin-top:10px;">
                <div>
                    <label>قیمت</label>
                    {{ formset.empty_form.price }}
                </div>
                <div>
                    <label>تخفیف (%)</label>
                    {{ formset.empty_form.discount_percent }}
                </div>
                <div>
                    <label>لینک خرید</label>
                    {{ formset.empty_form.buy_link }}
                </div>
            </div>
            <div style="margin-top:10px;">
                <label>{{ formset.empty_form.is_active }} فعال</label>
                {% if formset.empty_form.DELETE %}
                <label class="danger">{{ formset.empty_form.DELETE }} حذف محصول</label>
                {% endif %}
            </div>
        </div>
    </template>
</section>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        const addBtn = document.getElementById("add-product");
        const container = document.getElementById("products-container");
        const totalForms = document.getElementById("id_products-TOTAL_FORMS");
        const template = document.getElementById("empty-form-template");

        if (!addBtn || !container || !totalForms || !template) return;

        addBtn.addEventListener("click", function () {
            const index = parseInt(totalForms.value, 10);
            const html = template.innerHTML.replace(/__prefix__/g, index);
            const wrap = document.createElement("div");
            wrap.innerHTML = html.trim();
            container.appendChild(wrap.firstElementChild);
            totalForms.value = index + 1;
        });
    });
</script>
<script src="{% static 'subdomain-check.js' %}"></script>
{% endblock %}
